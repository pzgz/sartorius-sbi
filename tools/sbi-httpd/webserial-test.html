<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible"
        content="IE=edge">
  <meta name="viewport"
        content="width=device-width, initial-scale=1">

  <title>Sartorius Scale WebSerial Test</title>

  <!-- Bootstrap -->
  <link rel="stylesheet"
        href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
        integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
        crossorigin="anonymous">

  <!-- Optional theme -->
  <link rel="stylesheet"
        href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"
        integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp"
        crossorigin="anonymous">

  <style>
    .badge-danger {
      background-color: #d9534f;
    }

    .badge-success {
      background-color: #5cb85c;
    }

    .badge-primary {
      background-color: #337ab7;
    }

    .badge-warning {
      background-color: #f0ad4e;
    }

    .text-success {
      color: #5cb85c !important;
    }

    .text-danger {
      color: #d9534f !important;
    }

    .btn.active {
      box-shadow: inset 0 3px 5px rgba(0, 0, 0, .3);
      background-color: #337ab7;
      border-color: #2e6da4;
      color: #fff;
    }

    .log-entry {
      transition: all 0.3s ease;
    }

    .log-entry:hover {
      background-color: rgba(51, 122, 183, 0.1);
      border-radius: 3px;
      padding: 2px;
    }

    #weight {
      font-size: 3em;
      font-weight: bold;
      color: #2c5282;
      line-height: 1.2;
    }

    .well {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      border: none;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .weight-container {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .alert-webserial {
      background-color: #e3f2fd;
      border-color: #2196f3;
      color: #1976d2;
    }
  </style>
</head>

<body>

  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button"
                class="navbar-toggle collapsed"
                data-toggle="collapse"
                data-target="#navbar"
                aria-expanded="false"
                aria-controls="navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand"
           href="#">Sartorius Scale WebSerial</a>
      </div>
      <div id="navbar"
           class="collapse navbar-collapse">
        <ul class="navbar-nav navbar-right">
          <li class="navbar-text">
            è¿æ¥çŠ¶æ€: <span id="connectionStatus"
                  class="text-danger">æœªè¿æ¥</span>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container"
       style="margin-top: 70px;">

    <!-- WebSerial æ”¯æŒæ£€æµ‹ -->
    <div id="webserialAlert"
         class="alert alert-webserial"
         style="display: none;">
      <strong>æ³¨æ„:</strong>
      <span id="webserialMessage">æ£€æµ‹ WebSerial API æ”¯æŒä¸­...</span>
    </div>

    <!-- é‡é‡æ˜¾ç¤º -->
    <div class="row">
      <div class="col-md-6">
        <div class="panel panel-primary">
          <div class="panel-heading">
            <h3 class="panel-title">å½“å‰é‡é‡</h3>
          </div>
          <div class="panel-body">
            <div class="well">
              <div class="weight-container">
                <div id="weight">ç­‰å¾…è¿æ¥...</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="panel panel-info">
          <div class="panel-heading">
            <h3 class="panel-title">è®¾å¤‡ä¿¡æ¯</h3>
          </div>
          <div class="panel-body">
            <table class="table table-condensed">
              <tr>
                <td><strong>è¿æ¥æ–¹å¼:</strong></td>
                <td>WebSerial (æµè§ˆå™¨ç›´è¿)</td>
              </tr>
              <tr>
                <td><strong>è®¾å¤‡ä¿¡æ¯:</strong></td>
                <td id="deviceInfo">-</td>
              </tr>
              <tr>
                <td><strong>åºåˆ—å·:</strong></td>
                <td id="serialNumber">-</td>
              </tr>
              <tr>
                <td><strong>çŠ¶æ€:</strong></td>
                <td id="scaleStatus">æœªçŸ¥</td>
              </tr>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- è¿æ¥é…ç½® -->
    <div class="row">
      <div class="col-md-12">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title">ä¸²å£è¿æ¥é…ç½®</h3>
          </div>
          <div class="panel-body">
            <div class="row">
              <div class="col-md-2">
                <div class="form-group">
                  <label for="baudRate">æ³¢ç‰¹ç‡</label>
                  <select class="form-control"
                          id="baudRate">
                    <option value="1200">1200</option>
                    <option value="9600"
                            selected>9600</option>
                    <option value="38400">38400</option>
                  </select>
                </div>
              </div>
              <div class="col-md-2">
                <div class="form-group">
                  <label for="dataBits">æ•°æ®ä½</label>
                  <select class="form-control"
                          id="dataBits">
                    <option value="7">7</option>
                    <option value="8"
                            selected>8</option>
                  </select>
                </div>
              </div>
              <div class="col-md-2">
                <div class="form-group">
                  <label for="stopBits">åœæ­¢ä½</label>
                  <select class="form-control"
                          id="stopBits">
                    <option value="1"
                            selected>1</option>
                    <option value="2">2</option>
                  </select>
                </div>
              </div>
              <div class="col-md-2">
                <div class="form-group">
                  <label for="parity">æ ¡éªŒä½</label>
                  <select class="form-control"
                          id="parity">
                    <option value="none">æ— æ ¡éªŒ</option>
                    <option value="odd"
                            selected>å¥‡æ ¡éªŒ</option>
                    <option value="even">å¶æ ¡éªŒ</option>
                  </select>
                </div>
              </div>
              <div class="col-md-2">
                <div class="form-group">
                  <label for="responseTimeout">è¶…æ—¶(ms)</label>
                  <input type="number"
                         class="form-control"
                         id="responseTimeout"
                         value="200"
                         min="100"
                         max="5000">
                </div>
              </div>
              <div class="col-md-2">
                <div class="form-group">
                  <label for="precision">ç²¾åº¦</label>
                  <select class="form-control"
                          id="precision">
                    <option value="3">3ä½å°æ•°</option>
                    <option value="2">2ä½å°æ•°</option>
                    <option value="1"
                            selected>1ä½å°æ•°</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-3">
                <div class="form-group">
                  <label for="dataFormat">æ•°æ®æ ¼å¼</label>
                  <select class="form-control"
                          id="dataFormat">
                    <option value="22"
                            selected>22ä½æ ¼å¼ (å¸¦6ä½ID)</option>
                    <option value="16">16ä½æ ¼å¼ (æ ‡å‡†)</option>
                  </select>
                </div>
              </div>
              <div class="col-md-9">
                <div class="form-group">
                  <label>&nbsp;</label>
                  <div class="form-control-static">
                    <small class="text-muted">
                      <strong>22ä½:</strong> åŒ…å«6ä½è®¾å¤‡ID + 14ä½é‡é‡æ•°æ® |
                      <strong>16ä½:</strong> ä»…åŒ…å«14ä½é‡é‡æ•°æ®
                    </small>
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-8">
                <small class="text-muted">
                  <strong>Sartorius å¤©å¹³é»˜è®¤å‚æ•°:</strong> 9600æ³¢ç‰¹ç‡, 8æ•°æ®ä½, 3åœæ­¢ä½, å¥‡æ ¡éªŒ
                </small>
              </div>
              <div class="col-md-4 text-right">
                <div class="btn-group"
                     role="group">
                  <button type="button"
                          class="btn btn-xs btn-default"
                          id="presetSartorius">
                    Sartorius é»˜è®¤
                  </button>
                  <button type="button"
                          class="btn btn-xs btn-default"
                          id="presetNone">
                    æ— æ ¡éªŒæ¨¡å¼
                  </button>
                  <button type="button"
                          class="btn btn-xs btn-default"
                          id="presetEven">
                    å¶æ ¡éªŒæ¨¡å¼
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- æ§åˆ¶æŒ‰é’® -->
    <div class="row">
      <div class="col-md-12">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title">æ§åˆ¶é¢æ¿</h3>
          </div>
          <div class="panel-body">
            <div class="btn-group"
                 role="group">
              <button type="button"
                      class="btn btn-primary"
                      id="btnConnect">
                <span class="glyphicon glyphicon-link"></span> è¿æ¥å¤©å¹³
              </button>
              <button type="button"
                      class="btn btn-danger"
                      id="btnDisconnect"
                      disabled>
                <span class="glyphicon glyphicon-remove"></span> æ–­å¼€è¿æ¥
              </button>
            </div>

            <div class="btn-group"
                 role="group"
                 style="margin-left: 15px;">
              <button type="button"
                      class="btn btn-success"
                      id="btnGetWeight"
                      disabled>
                <span class="glyphicon glyphicon-scale"></span> è·å–é‡é‡
              </button>
              <button type="button"
                      class="btn btn-warning"
                      id="btnTare"
                      disabled>
                <span class="glyphicon glyphicon-refresh"></span> å»çš®
              </button>
              <button type="button"
                      class="btn btn-info"
                      id="btnToggle"
                      disabled>
                <span class="glyphicon glyphicon-transfer"></span> åˆ‡æ¢å•ä½
              </button>
            </div>

            <div class="btn-group"
                 role="group"
                 style="margin-left: 15px;">
              <button type="button"
                      class="btn btn-default"
                      id="btnStartListening"
                      disabled>
                <span class="glyphicon glyphicon-play"></span> å¼€å§‹ç›‘å¬
              </button>
              <button type="button"
                      class="btn btn-default"
                      id="btnStopListening"
                      disabled>
                <span class="glyphicon glyphicon-stop"></span> åœæ­¢ç›‘å¬
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- æ“ä½œæ—¥å¿— -->
    <div class="row">
      <div class="col-md-12">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title">æ“ä½œæ—¥å¿—</h3>
            <div class="pull-right">
              <button type="button"
                      class="btn btn-xs btn-default"
                      id="btnClearLog">æ¸…ç©ºæ—¥å¿—</button>
            </div>
            <div class="clearfix"></div>
          </div>
          <div class="panel-body"
               style="max-height: 400px; overflow-y: auto;">
            <div id="operationLog"></div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
          integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
          crossorigin="anonymous"></script>

  <!-- WebSerial Scale Implementation -->
  <script src="webserial-scale.js"></script>

  <script>
    $(function () {
      let scale = null;
      let isListening = false;

      // æ£€æŸ¥ WebSerial API æ”¯æŒ
      function checkWebSerialSupport() {
        if ('serial' in navigator) {
          $('#webserialAlert').show();
          $('#webserialMessage').text('âœ… æµè§ˆå™¨æ”¯æŒ WebSerial APIï¼Œå¯ä»¥ç›´æ¥è¿æ¥ä¸²å£è®¾å¤‡ã€‚');
          return true;
        } else {
          $('#webserialAlert').show();
          $('#webserialMessage').html('âŒ æµè§ˆå™¨ä¸æ”¯æŒ WebSerial APIã€‚è¯·ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ Chromeã€Edge æˆ–å…¶ä»–æ”¯æŒ WebSerial çš„æµè§ˆå™¨ã€‚<br><strong>æ³¨æ„:</strong> æŸäº›æµè§ˆå™¨éœ€è¦å¯ç”¨å®éªŒæ€§åŠŸèƒ½ï¼Œè¯·è®¿é—® chrome://flags/#enable-experimental-web-platform-features');
          return false;
        }
      }

      // æ·»åŠ æ—¥å¿—è®°å½•å‡½æ•°
      function addLog(message, type) {
        var timestamp = new Date().toLocaleTimeString();
        var badgeClass = 'badge-info';

        switch (type) {
          case 'manual': badgeClass = 'badge-warning'; break;
          case 'webserial': badgeClass = 'badge-info'; break;
          case 'error': badgeClass = 'badge-danger'; break;
          case 'success': badgeClass = 'badge-success'; break;
          case 'system': badgeClass = 'badge-primary'; break;
        }

        var logEntry = '<div class="log-entry" style="margin-bottom: 5px;">' +
          '<span class="badge ' + badgeClass + '">' + timestamp + '</span> ' +
          '<span style="margin-left: 10px;">' + message + '</span>' +
          '</div>';

        $('#operationLog').prepend(logEntry);

        // é™åˆ¶æ—¥å¿—æ¡ç›®æ•°é‡ï¼Œä¿æŒæœ€æ–°çš„30æ¡
        var logEntries = $('#operationLog .log-entry');
        if (logEntries.length > 30) {
          logEntries.slice(30).remove();
        }
      }

      // æ›´æ–°è¿æ¥çŠ¶æ€å’ŒæŒ‰é’®çŠ¶æ€
      function updateConnectionStatus(connected) {
        if (connected) {
          $('#connectionStatus').text('å·²è¿æ¥').removeClass('text-danger').addClass('text-success');
          $('#btnConnect').prop('disabled', true);
          $('#btnDisconnect').prop('disabled', false);
          $('#btnGetWeight, #btnTare, #btnToggle, #btnShowMessage, #btnStartListening').prop('disabled', false);
        } else {
          $('#connectionStatus').text('æœªè¿æ¥').removeClass('text-success').addClass('text-danger');
          $('#btnConnect').prop('disabled', false);
          $('#btnDisconnect').prop('disabled', true);
          $('#btnGetWeight, #btnTare, #btnToggle, #btnShowMessage, #btnStartListening, #btnStopListening').prop('disabled', true);
          $('#weight').text('ç­‰å¾…è¿æ¥...');
          $('#deviceInfo').text('-');
          $('#serialNumber').text('-');
          $('#scaleStatus').text('æœªçŸ¥');
        }
      }

      // è·å–è¿æ¥é…ç½®å‚æ•°
      function getConnectionOptions() {
        return {
          baudRate: parseInt($('#baudRate').val()),
          dataBits: parseInt($('#dataBits').val()),
          stopBits: parseInt($('#stopBits').val()),
          parity: $('#parity').val(),
          responseTimeout: parseInt($('#responseTimeout').val()),
          precision: parseInt($('#precision').val()),
          dataFormat: parseInt($('#dataFormat').val())
        };
      }

      // åº”ç”¨è¿æ¥å‚æ•°é¢„è®¾
      function applyConnectionPreset(preset) {
        switch (preset) {
          case 'sartorius':
            $('#baudRate').val('9600');
            $('#dataBits').val('8');
            $('#stopBits').val('1');
            $('#parity').val('odd');
            $('#responseTimeout').val('500');
            $('#precision').val('3');
            $('#dataFormat').val('22');
            addLog('ğŸ¯ å·²åº”ç”¨ Sartorius é»˜è®¤å‚æ•° (22ä½æ ¼å¼)', 'system');
            break;
          case 'none':
            $('#baudRate').val('9600');
            $('#dataBits').val('8');
            $('#stopBits').val('1');
            $('#parity').val('none');
            $('#responseTimeout').val('200');
            $('#precision').val('3');
            $('#dataFormat').val('22');
            addLog('ğŸ¯ å·²åº”ç”¨æ— æ ¡éªŒæ¨¡å¼å‚æ•° (22ä½æ ¼å¼)', 'system');
            break;
          case 'even':
            $('#baudRate').val('9600');
            $('#dataBits').val('8');
            $('#stopBits').val('1');
            $('#parity').val('even');
            $('#responseTimeout').val('200');
            $('#precision').val('3');
            $('#dataFormat').val('22');
            addLog('ğŸ¯ å·²åº”ç”¨å¶æ ¡éªŒæ¨¡å¼å‚æ•° (22ä½æ ¼å¼)', 'system');
            break;
        }
      }

      // äº‹ä»¶ç›‘å¬å™¨
      $('#btnConnect').click(async function () {
        try {
          // è·å–ç”¨æˆ·é€‰æ‹©çš„è¿æ¥å‚æ•°
          const options = getConnectionOptions();
          addLog('ğŸ”§ è¿æ¥å‚æ•°: ' + JSON.stringify(options), 'system');

          scale = new WebSerialScale(options);

          // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
          scale.on('weight', function (weight, uom) {
            $('#weight').text(weight + (uom || ''));
            addLog('âš–ï¸ é‡é‡: ' + weight + ' ' + (uom || ''), 'system');
          });

          scale.on('data', function (rawData) {
            addLog('ğŸ“¡ åŸå§‹æ•°æ®: ' + rawData, 'system');
          });

          scale.on('error', function (error) {
            addLog('âŒ é”™è¯¯: ' + error, 'error');
          });

          await scale.connect();
          updateConnectionStatus(true);
          addLog('âœ… å·²è¿æ¥åˆ°å¤©å¹³', 'success');

          // è·å–è®¾å¤‡ä¿¡æ¯
          try {
            const deviceInfo = await scale.getDeviceInfo();
            $('#deviceInfo').text(deviceInfo);
            addLog('ğŸ“± è®¾å¤‡ä¿¡æ¯: ' + deviceInfo, 'system');
          } catch (e) {
            addLog('âš ï¸ æ— æ³•è·å–è®¾å¤‡ä¿¡æ¯: ' + e.message, 'error');
          }

          try {
            const serialNumber = await scale.getSerialNumber();
            $('#serialNumber').text(serialNumber);
            addLog('ğŸ”¢ åºåˆ—å·: ' + serialNumber, 'system');
          } catch (e) {
            addLog('âš ï¸ æ— æ³•è·å–åºåˆ—å·: ' + e.message, 'error');
          }

        } catch (error) {
          addLog('âŒ è¿æ¥å¤±è´¥: ' + error.message, 'error');
        }
      });

      $('#btnDisconnect').click(function () {
        if (scale) {
          if (isListening) {
            scale.stopListening();
            isListening = false;
            $('#btnStartListening').prop('disabled', false);
            $('#btnStopListening').prop('disabled', true);
          }
          scale.disconnect();
          scale = null;
          updateConnectionStatus(false);
          addLog('ğŸ”Œ å·²æ–­å¼€è¿æ¥', 'system');
        }
      });

      $('#btnGetWeight').click(async function () {
        if (scale) {
          try {
            const result = await scale.getWeight();
            $('#weight').text(result.weight + (result.uom || ''));
            addLog('âš–ï¸ æ‰‹åŠ¨è·å–é‡é‡: ' + result.weight + ' ' + (result.uom || ''), 'webserial');
          } catch (error) {
            addLog('âŒ è·å–é‡é‡å¤±è´¥: ' + error.message, 'error');
          }
        }
      });

      $('#btnTare').click(async function () {
        if (scale) {
          try {
            await scale.tare();
            addLog('âœ… å»çš®æ“ä½œå®Œæˆ', 'success');
          } catch (error) {
            addLog('âŒ å»çš®æ“ä½œå¤±è´¥: ' + error.message, 'error');
          }
        }
      });

      $('#btnToggle').click(async function () {
        if (scale) {
          try {
            await scale.toggle();
            addLog('âœ… å•ä½åˆ‡æ¢å®Œæˆ', 'success');
          } catch (error) {
            addLog('âŒ å•ä½åˆ‡æ¢å¤±è´¥: ' + error.message, 'error');
          }
        }
      });

      $('#btnShowMessage').click(async function () {
        if (scale) {
          const message = $('#messageText').val();
          try {
            await scale.showMessage(message);
            addLog('ğŸ“ æ¶ˆæ¯å·²å‘é€åˆ°å¤©å¹³: ' + message, 'success');
            $('#messageText').val('');
          } catch (error) {
            addLog('âŒ å‘é€æ¶ˆæ¯å¤±è´¥: ' + error.message, 'error');
          }
        }
      });

      $('#btnStartListening').click(function () {
        if (scale) {
          scale.startListening();
          isListening = true;
          $('#btnStartListening').prop('disabled', true);
          $('#btnStopListening').prop('disabled', false);
          addLog('ğŸ‘‚ å¼€å§‹è¢«åŠ¨ç›‘å¬æ¨¡å¼', 'system');
        }
      });

      $('#btnStopListening').click(function () {
        if (scale) {
          scale.stopListening();
          isListening = false;
          $('#btnStartListening').prop('disabled', false);
          $('#btnStopListening').prop('disabled', true);
          addLog('â¹ï¸ åœæ­¢ç›‘å¬æ¨¡å¼', 'system');
        }
      });

      $('#btnClearLog').click(function () {
        $('#operationLog').empty();
      });

      // é¢„è®¾æŒ‰é’®äº‹ä»¶
      $('#presetSartorius').click(function () {
        applyConnectionPreset('sartorius');
      });

      $('#presetNone').click(function () {
        applyConnectionPreset('none');
      });

      $('#presetEven').click(function () {
        applyConnectionPreset('even');
      });

      // å…è®¸æŒ‰å›è½¦é”®å‘é€æ¶ˆæ¯
      $('#messageText').keypress(function (e) {
        if (e.which === 13) { // Enter key
          $('#btnShowMessage').click();
        }
      });

      // åˆå§‹åŒ–
      checkWebSerialSupport();
      updateConnectionStatus(false);
      addLog('ğŸš€ WebSerial æµ‹è¯•é¡µé¢å·²åŠ è½½', 'system');
    });
  </script>
</body>

</html>