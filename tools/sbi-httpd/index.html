<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible"
          content="IE=edge">
    <meta name="viewport"
          content="width=device-width, initial-scale=1">

    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Sartorius Scale Monitor</title>

    <!-- Bootstrap -->
    <link rel="stylesheet"
          href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
          crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet"
          href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"
          integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp"
          crossorigin="anonymous">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <style>
        .badge-danger {
            background-color: #d9534f;
        }

        .badge-success {
            background-color: #5cb85c;
        }

        .badge-primary {
            background-color: #337ab7;
        }

        .text-success {
            color: #5cb85c !important;
        }

        .text-danger {
            color: #d9534f !important;
        }

        .btn.active {
            box-shadow: inset 0 3px 5px rgba(0, 0, 0, .3);
            background-color: #337ab7;
            border-color: #2e6da4;
            color: #fff;
        }

        .log-entry {
            transition: all 0.3s ease;
        }

        .log-entry:hover {
            background-color: rgba(51, 122, 183, 0.1);
            border-radius: 3px;
            padding: 2px;
        }

        #weight {
            font-size: 3em;
            font-weight: bold;
            color: #2c5282;
            line-height: 1.2;
        }

        .well {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .weight-container {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <p class="navbar-text"> &nbsp; <span class="glyphicon glyphicon-scale"></span> Model: <span
                          id="deviceInfo"></span> (<span id="serialNumber"></span>) | Mode: <span
                          id="currentMode">-</span> |
                    Status: <span id="connectionStatus">Connecting...</span></p>
            </div>
        </div>
    </nav>

    <div class="container"
         style="padding-top:75px;">

        <div class="row">
            <div class="col-sm-offset-2 col-sm-6">
                <div class="well"
                     style="height:100px;">
                    <div class="weight-container">
                        <span id="weight">ç­‰å¾…æ•°æ®...</span>
                    </div>
                </div>
            </div>
            <div class="col-sm-2">
                <button id="btnTare"
                        class="btn btn-lg btn-primary btn-block">Tare</button>
                <button id="btnToggle"
                        class="btn btn-lg btn-default btn-block">Toggle</button>
            </div>
        </div>

        <div class="row"
             style="margin-top:15px;">
            <div class="col-sm-offset-2 col-sm-8">
                <div class="btn-group btn-group-justified"
                     role="group">
                    <div class="btn-group"
                         role="group">
                        <button id="btnGetWeight"
                                class="btn btn-info">ğŸ”„ Get Weight</button>
                    </div>
                    <div class="btn-group"
                         role="group">
                        <button id="btnGetStatus"
                                class="btn btn-info">ğŸ“Š Get Status</button>
                    </div>
                    <div class="btn-group"
                         role="group">
                        <button id="btnShowMessage"
                                class="btn btn-warning">ğŸ’¬ Show Message</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row"
             style="margin-top:10px;">
            <div class="col-sm-offset-2 col-sm-8">
                <div class="btn-group btn-group-justified"
                     role="group">
                    <div class="btn-group"
                         role="group">
                        <button id="btnSwitchPassive"
                                class="btn btn-success">ğŸ“¡ Passive Mode</button>
                    </div>
                    <div class="btn-group"
                         role="group">
                        <button id="btnSwitchActive"
                                class="btn btn-primary">ğŸ”„ Active Mode</button>
                    </div>
                    <div class="btn-group"
                         role="group">
                        <button id="btnClearLog"
                                class="btn btn-default">ğŸ—‘ï¸ Clear Log</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row"
             style="margin-top:20px;">
            <div class="col-sm-offset-2 col-sm-8">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h5 class="panel-title">ğŸ“‹ æ“ä½œæ—¥å¿— & ç³»ç»ŸçŠ¶æ€</h5>
                    </div>
                    <div class="panel-body"
                         style="height:200px; overflow-y:auto; font-size: 13px;">
                        <div id="operationLog"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
            integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
            crossorigin="anonymous"></script>

    <script src="/socket.io/socket.io.js"></script>

    <script>
        $(function () {

            var socket = io();
            var currentMode = 'unknown';

            // æ·»åŠ æ—¥å¿—è®°å½•å‡½æ•°
            function addLog(message, type) {
                var timestamp = new Date().toLocaleTimeString();
                var badgeClass = 'badge-info';

                switch (type) {
                    case 'manual': badgeClass = 'badge-warning'; break;
                    case 'web': badgeClass = 'badge-info'; break;
                    case 'error': badgeClass = 'badge-danger'; break;
                    case 'success': badgeClass = 'badge-success'; break;
                    case 'system': badgeClass = 'badge-primary'; break;
                }

                var logEntry = '<div class="log-entry" style="margin-bottom: 5px;">' +
                    '<span class="badge ' + badgeClass + '">' + timestamp + '</span> ' +
                    '<span style="margin-left: 10px;">' + message + '</span>' +
                    '</div>';

                $('#operationLog').prepend(logEntry);

                // é™åˆ¶æ—¥å¿—æ¡ç›®æ•°é‡ï¼Œä¿æŒæœ€æ–°çš„30æ¡
                var logEntries = $('#operationLog .log-entry');
                if (logEntries.length > 30) {
                    logEntries.slice(30).remove();
                }
            }

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            function updateModeButtons() {
                $('#btnSwitchPassive').toggleClass('active', currentMode === 'passive');
                $('#btnSwitchActive').toggleClass('active', currentMode === 'active');
            }

            // Socket.IO äº‹ä»¶ç›‘å¬
            socket.on('connect', function () {
                $('#connectionStatus').text('Connected').removeClass('text-danger').addClass('text-success');
                addLog('âœ… è¿æ¥åˆ°æœåŠ¡å™¨', 'system');
            });

            socket.on('disconnect', function () {
                $('#connectionStatus').text('Disconnected').removeClass('text-success').addClass('text-danger');
                addLog('âŒ ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥', 'error');
            });

            socket.on('connected', function (data) {
                currentMode = data.mode;
                $('#currentMode').text(data.mode);
                $('#deviceInfo').text(data.deviceInfo || '-');
                $('#serialNumber').text(data.serialNumber || '-');

                updateModeButtons();
                addLog('ğŸ“± æœåŠ¡å™¨æ¨¡å¼: ' + data.mode + ', è®¾å¤‡: ' + (data.deviceInfo || 'æœªçŸ¥'), 'system');

                if (data.currentWeight && data.currentWeight.weight !== undefined) {
                    $('#weight').text(data.currentWeight.weight + (data.currentWeight.uom || ''));
                } else {
                    $('#weight').text('ç­‰å¾…é‡é‡æ•°æ®...');
                }
            });

            socket.on('weight', function (data) {
                if (data && data.weight !== undefined) {
                    $('#weight').text(data.weight + (data.uom || ''));
                    addLog('âš–ï¸ é‡é‡: ' + data.weight + ' ' + (data.uom || ''), 'system');
                } else {
                    $('#weight').text('æ— é‡é‡æ•°æ®');
                }
            });

            socket.on('rawData', function (data) {
                addLog('ğŸ“¡ åŸå§‹æ•°æ®: ' + data.data, 'system');
            });

            socket.on('error', function (data) {
                addLog('âŒ å¤©å¹³é”™è¯¯: ' + data.error, 'error');
            });

            socket.on('keyPress', function (data) {
                addLog('ğŸ”˜ æŒ‰é”®: ' + data.name, 'manual');
            });

            socket.on('tared', function (data) {
                if (data && data.timestamp) {
                    addLog('âœ… å»çš®æ“ä½œå®Œæˆ', 'success');
                } else {
                    addLog('å¤©å¹³ç‰©ç†æŒ‰é”®ï¼šå»çš®æ“ä½œ', 'manual');
                }
            });

            socket.on('toggled', function (data) {
                if (data && data.timestamp) {
                    addLog('âœ… å•ä½åˆ‡æ¢å®Œæˆ', 'success');
                } else {
                    addLog('å¤©å¹³ç‰©ç†æŒ‰é”®ï¼šå•ä½åˆ‡æ¢', 'manual');
                }
            });

            socket.on('modeChanged', function (data) {
                currentMode = data.currentMode;
                $('#currentMode').text(data.currentMode);
                updateModeButtons();
                addLog('ğŸ”„ æ¨¡å¼åˆ‡æ¢åˆ°: ' + data.currentMode, 'system');
            });

            // åˆå§‹åŒ–ï¼šè·å–è®¾å¤‡ä¿¡æ¯
            socket.emit('deviceInfo', null, function (response) {
                if (response && response.deviceInfo) {
                    $('#deviceInfo').text(response.deviceInfo);
                }
            });

            socket.emit('serialNumber', null, function (response) {
                if (response && response.serialNumber) {
                    $('#serialNumber').text(response.serialNumber);
                }
            });

            // æŒ‰é’®äº‹ä»¶å¤„ç†
            $('#btnTare').click(function (ev) {
                ev.preventDefault();
                addLog('ç½‘é¡µæŒ‰é’®ï¼šå»çš®æ“ä½œ', 'web');
                socket.emit('tare', {}, function (response) {
                    if (!response.success) {
                        addLog('âŒ å»çš®å¤±è´¥: ' + response.error, 'error');
                    }
                });
            });

            $('#btnToggle').click(function (ev) {
                ev.preventDefault();
                addLog('ç½‘é¡µæŒ‰é’®ï¼šå•ä½åˆ‡æ¢', 'web');
                socket.emit('toggle', {}, function (response) {
                    if (!response.success) {
                        addLog('âŒ å•ä½åˆ‡æ¢å¤±è´¥: ' + response.error, 'error');
                    }
                });
            });

            $('#btnGetWeight').click(function (ev) {
                ev.preventDefault();
                addLog('ç½‘é¡µæŒ‰é’®ï¼šè·å–é‡é‡', 'web');
                socket.emit('getWeight', {}, function (response) {
                    if (response.success) {
                        $('#weight').text(response.weight + (response.uom || '_'));
                        addLog('ğŸ“Š å½“å‰é‡é‡: ' + response.weight + ' ' + (response.uom || ''), 'success');
                    } else {
                        addLog('âŒ è·å–é‡é‡å¤±è´¥: ' + response.error, 'error');
                    }
                });
            });

            $('#btnGetStatus').click(function (ev) {
                ev.preventDefault();
                addLog('ç½‘é¡µæŒ‰é’®ï¼šè·å–çŠ¶æ€', 'web');
                socket.emit('getStatus', {}, function (response) {
                    if (response.success) {
                        addLog('ğŸ“Š å¤©å¹³çŠ¶æ€: ' + response.status, 'success');
                    } else {
                        addLog('âŒ è·å–çŠ¶æ€å¤±è´¥: ' + response.error, 'error');
                    }
                });
            });

            $('#btnShowMessage').click(function (ev) {
                ev.preventDefault();
                var message = prompt('è¯·è¾“å…¥è¦åœ¨å¤©å¹³ä¸Šæ˜¾ç¤ºçš„æ¶ˆæ¯:', 'HELLO');
                if (message !== null) {
                    addLog('ç½‘é¡µæŒ‰é’®ï¼šæ˜¾ç¤ºæ¶ˆæ¯ "' + message + '"', 'web');
                    socket.emit('showMessage', { text: message }, function (response) {
                        if (response.success) {
                            addLog('âœ… æ¶ˆæ¯å·²æ˜¾ç¤º: ' + message, 'success');
                        } else {
                            addLog('âŒ æ˜¾ç¤ºæ¶ˆæ¯å¤±è´¥: ' + response.error, 'error');
                        }
                    });
                }
            });

            $('#btnSwitchPassive').click(function (ev) {
                ev.preventDefault();
                if (currentMode === 'passive') {
                    addLog('â„¹ï¸ å·²ç»æ˜¯è¢«åŠ¨æ¨¡å¼', 'web');
                    return;
                }
                addLog('ç½‘é¡µæŒ‰é’®ï¼šåˆ‡æ¢åˆ°è¢«åŠ¨æ¨¡å¼', 'web');
                socket.emit('switchMode', { mode: 'passive' }, function (response) {
                    if (!response.success) {
                        addLog('âŒ åˆ‡æ¢æ¨¡å¼å¤±è´¥: ' + response.error, 'error');
                    }
                });
            });

            $('#btnSwitchActive').click(function (ev) {
                ev.preventDefault();
                if (currentMode === 'active') {
                    addLog('â„¹ï¸ å·²ç»æ˜¯ä¸»åŠ¨æ¨¡å¼', 'web');
                    return;
                }
                addLog('ç½‘é¡µæŒ‰é’®ï¼šåˆ‡æ¢åˆ°ä¸»åŠ¨æ¨¡å¼', 'web');
                socket.emit('switchMode', { mode: 'active' }, function (response) {
                    if (!response.success) {
                        addLog('âŒ åˆ‡æ¢æ¨¡å¼å¤±è´¥: ' + response.error, 'error');
                    }
                });
            });

            $('#btnClearLog').click(function (ev) {
                ev.preventDefault();
                $('#operationLog').empty();
                addLog('ğŸ—‘ï¸ æ—¥å¿—å·²æ¸…ç©º', 'web');
            });

            // for debugging
            window.socket = socket;

        });
    </script>

</body>

</html>