# WebSerial 天平测试

这是一个基于浏览器 WebSerial API 的天平直连测试工具，可以直接在浏览器中与 Sartorius 天平通信，无需后端服务器。

## 文件说明

- `webserial-test.html` - WebSerial 测试页面
- `webserial-scale.js` - WebSerial Scale 的 JavaScript 实现
- `WEBSERIAL-README.md` - 本说明文件

## 浏览器支持

WebSerial API 目前支持以下浏览器：
- Chrome 89+ (推荐)
- Edge 89+
- Opera 75+

**注意：** 某些浏览器可能需要启用实验性功能。如果遇到不支持的提示，请：
1. 访问 `chrome://flags/#enable-experimental-web-platform-features`
2. 启用 "Experimental Web Platform features"
3. 重启浏览器

## 功能特性

### ✅ 与后端相同的功能
- **被动监听模式** - 类似后端的 `passive` 模式，自动接收天平发送的重量数据
- **手动获取重量** - 主动请求当前重量
- **去皮操作** - 执行天平归零
- **单位切换** - 在克(g)和磅(/lb)之间切换
- **消息显示** - 在天平显示屏上显示自定义消息
- **设备信息获取** - 获取天平设备信息和序列号

### 🆕 WebSerial 特有功能
- **浏览器直连** - 无需后端服务器，直接与天平通信
- **实时日志** - 详细的操作日志和数据传输记录
- **连接状态管理** - 完整的连接/断开连接控制

## 使用方法

### 1. 打开测试页面
直接在支持 WebSerial 的浏览器中打开 `webserial-test.html` 文件：
```bash
# 在 tools/sbi-httpd 目录下
open webserial-test.html
# 或者在浏览器中打开文件
```

### 2. 配置连接参数
在连接前，可以根据你的天平型号调整连接参数：
- **波特率**: 1200, 9600 (默认), 38400
- **数据位**: 7, 8 (默认)
- **停止位**: 1 (默认), 2
- **校验位**: 无校验, 奇校验 (默认), 偶校验
- **超时时间**: 100-5000毫秒 (默认200)
- **精度**: 1-3位小数 (默认1位)
- **数据格式**: 22位格式 (默认, 包含6位ID) 或 16位格式 (标准)

**快速预设**：
- **Sartorius 默认**: 9600波特率, 8数据位, 1停止位, 奇校验, 22位格式
- **无校验模式**: 相同参数但无校验
- **偶校验模式**: 相同参数但偶校验

### 3. 连接天平
1. 确保天平已通过 USB 或串口连接到电脑
2. 根据天平规格选择正确的连接参数（或使用预设）
3. 点击 "连接天平" 按钮
4. 在弹出的串口选择对话框中选择对应的串口设备
5. 连接成功后，页面将显示设备信息

### 4. 开始监听
点击 "开始监听" 按钮启动被动监听模式，此时：
- 天平发送的重量数据会自动显示
- 天平按键操作会被记录在日志中
- 实时重量变化会在页面上更新

### 5. 手动操作
连接后可以使用以下功能：
- **获取重量** - 手动请求当前重量
- **去皮** - 执行归零操作
- **切换单位** - 在克和磅之间切换
- **显示消息** - 在天平上显示自定义文本

## 与后端模式的对比

| 功能 | 后端模式 | WebSerial 模式 |
|------|----------|----------------|
| 连接方式 | Node.js + Socket.IO | 浏览器直连 |
| 被动监听 | ✅ | ✅ |
| 重量获取 | ✅ | ✅ |
| 去皮操作 | ✅ | ✅ |
| 单位切换 | ✅ | ✅ |
| 消息显示 | ✅ | ✅ |
| 设备信息 | ✅ | ✅ |
| 按键检测 | ✅ | ✅ |
| 服务器依赖 | 需要 | 不需要 |
| 多客户端 | 支持 | 单一浏览器 |
| 权限要求 | 无 | 用户授权 |

## 协议实现

WebSerial 版本完全移植了 Node.js 版本的 SBI 协议实现：
- 使用相同的命令集 (`ESC + "P"` 获取重量等)
- 相同的数据解析逻辑
- 相同的错误处理机制
- 相同的事件系统

## 调试信息

页面提供了详细的调试信息：
- **操作日志** - 记录所有操作和数据传输
- **原始数据** - 显示从天平接收的原始数据
- **错误信息** - 详细的错误信息和解决建议
- **浏览器控制台** - 开发者工具中的详细日志

## 故障排除

### 无法连接天平
1. 检查天平是否正确连接到电脑
2. 确认浏览器支持 WebSerial API
3. 检查是否选择了正确的串口设备
4. 确认天平电源已打开
5. **尝试不同的连接参数**：
   - 如果连接失败，先尝试 "Sartorius 默认" 预设
   - 如果仍然失败，尝试 "无校验模式" 预设
   - 检查天平手册确认正确的连接参数
   - 某些天平可能需要不同的波特率或校验设置

### 无重量数据
1. 检查天平是否处于称重模式
2. 确认连接稳定
3. 尝试手动获取重量
4. 检查天平显示是否正常

### 浏览器不支持
1. 更新到最新版本的 Chrome 或 Edge
2. 启用实验性 Web 平台功能
3. 确认在 HTTPS 环境下使用（某些浏览器要求）

## 安全说明

- WebSerial API 需要用户明确授权才能访问串口设备
- 每次刷新页面都需要重新选择串口设备
- 建议在安全的网络环境下使用

## 开发说明

如需修改或扩展功能，主要文件说明：
- `webserial-scale.js` 中的 `WebSerialScale` 类包含所有天平通信逻辑
- `SBI` 对象定义了所有天平命令和协议
- `EventEmitter` 提供了事件系统支持
- HTML 中的 JavaScript 处理 UI 交互和状态管理 